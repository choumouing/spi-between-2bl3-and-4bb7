# 多芯片SPI通信方案可行性分析

> **文档版本**：v4.3（DMA开发进行中）
> **日期**：2025年12月
> **项目**：3×CYT2BL3 + 1×CYT4BB7 SPI通信系统
> **修订说明**：v4.3 第二阶段DMA优化开发中，FIFO批量填充作为已验证的备选方案

---

## 一、方案概述

### 1.1 系统架构

```
                    ┌─────────────────┐
                    │   CYT4BB7       │
                    │   (SPI主机)     │
                    │                 │
                    │  SPI_0 (SCB7) ──┼─────┬─────┬───── 共享总线
                    │                 │     │     │
                    │  GPIO CS控制    │     │     │
                    │    CS_1 (P02_3)─┼─────┼─────┼──► 2BL3_1
                    │    CS_2 (P01_0)─┼─────┼─────┼──► 2BL3_2
                    │    CS_3 (P19_0)─┼─────┼─────┼──► 2BL3_3
                    │                 │     │     │
                    │  GPIO INT检测   │     │     │
                    │    INT_1 (P02_4)◄─────┼─────┼─── 2BL3_1
                    │    INT_2 (P01_1)◄─────┼─────┼─── 2BL3_2
                    │    INT_3 (P19_1)◄─────┼─────┼─── 2BL3_3
                    │                 │     │     │
                    └─────────────────┘     │     │
```

### 1.2 各芯片功能定位

| 芯片 | 角色 | 主要功能 |
|------|------|----------|
| CYT4BB7 | 主机 | SPI主机通信×3、图像特征融合、运动学解算、全向移动控制 |
| CYT2BL3_1 | 从机 | 摄像头图像采集处理、信标检测、菜单系统、SPI从机通信 |
| CYT2BL3_2 | 从机 | 摄像头图像采集处理、信标检测、菜单系统、SPI从机通信 |
| CYT2BL3_3 | 从机 | 摄像头图像采集处理、信标检测、菜单系统、SPI从机通信 |

### 1.3 已确认的需求参数

| 参数 | 确认值 | 备注 |
|------|--------|------|
| 物理连接 | 排线约5cm（测试），PCB直连（将来） | SPI时钟需可便捷切换 |
| 通信频率 | 100Hz | 需可便捷更改 |
| 实施方案 | 单硬件SPI + 3个GPIO CS | 方案D |
| INT信号 | 需要 | 事件驱动通信 |
| 菜单系统 | 3个从机独立 | 照搬mknm_car_new设计 |
| 开发策略 | 先中断模式，后DMA | 渐进式开发 |
| 测试策略 | 先1主1从，后扩展3从 | 分阶段验证 |

### 1.4 当前实现状态

| 阶段 | 状态 | 说明 |
|------|------|------|
| 第一阶段：基础通信验证 | ✅ **已完成** | 1主1从SPI通信验证成功 |
| 第二阶段：主机DMA优化 | 🔄 **进行中** | 实现主机端DMA传输 |
| 第三阶段：多从机扩展 | ⏳ 待开始 | 扩展到3个从机 |

**备选方案**：FIFO批量填充（已验证，保留在 `fifo-batch-transfer` 分支）

**备选方案说明**：
- FIFO批量填充方式已在 `fifo-batch-transfer` 分支验证成功
- 对于小数据量（14字节）传输简单可靠
- 主机DMA优化用于支持将来更大数据量传输场景

---

## 二、硬件资源可行性分析

### 2.1 CYT4BB7资源分析

#### 2.1.1 SCB模块资源

根据Infineon官方数据手册：

| 特性 | 规格 |
|------|------|
| SCB总数 | **11个** (SCB0-SCB10) |
| SPI最大时钟 | 12.5 MHz |
| FIFO深度 | 可配置 |
| DMA支持 | 完善的PDMA支持 |

#### 2.1.2 逐飞库SPI通道映射（4BB7）

```c
// 来源：zf_driver_spi.c:48
volatile stc_SCB_t* spi_module[4] = {SCB7, SCB8, SCB9, SCB6};

// SPI_0 -> SCB7: P02_0/P02_1/P02_2/P02_3 ✅ 本项目使用
// SPI_1 -> SCB8: P12_0/P12_1/P12_2/P12_3 (IPS114占用)
// SPI_2 -> SCB9: P15_0/P15_1/P15_2/P15_3 (IMU660RA占用)
// SPI_3 -> SCB6: P03_0/P03_1/P03_2/P03_3
```

#### 2.1.3 mknm_car_new SPI资源占用情况

| SPI通道 | SCB | 引脚端口 | **占用设备** | **状态** |
|--------|-----|---------|-------------|----------|
| **SPI_0** | **SCB7** | **P02端口** | **WiFi未启用** | ✅ **本项目使用** |
| SPI_1 | SCB8 | P12端口 | **IPS114屏幕** | ❌ 已占用 |
| SPI_2 | SCB9 | P15端口 | **IMU660RA** | ❌ 已占用 |
| SPI_3 | SCB6 | P03端口 | 未使用 | ✅ 可用(备选) |

### 2.2 CYT2BL3资源分析

#### 2.2.1 SCB模块资源

| 特性 | 规格 |
|------|------|
| SCB总数 | **8个** (SCB0-SCB7) |
| SPI支持 | 主机和从机模式 |
| SPI最大时钟 | 12.5 MHz |

#### 2.2.2 逐飞库SPI通道映射（2BL3）

```c
// 来源：zf_driver_spi.c:48
volatile stc_SCB_t* spi_module[4] = {SCB4, SCB5, SCB3, SCB2};

// SPI_1 -> SCB4: P06端口 (摄像头数据占用)
// SPI_2 -> SCB5: P07端口
// SPI_3 -> SCB3: P13端口 (IPS114屏幕占用)
// SPI_4 -> SCB2: P14端口 (无硬件SS引脚，不可用于从机模式)
```

**重要发现**: SCB2的P14端口没有SPI_SELECT0的HSIOM定义，无法作为SPI从机使用硬件SS引脚。

#### 2.2.3 SPI从机可用资源分析

经过对gpio_cyt2bl_64_lqfp.h的详细分析，只有**SCB0**具备完整的SPI从机功能：

| SCB | 引脚端口 | SELECT0支持 | 占用状态 | 可用性 |
|-----|---------|-------------|----------|--------|
| SCB0 | P0_x | ✅ P0_3 | **未占用** | ✅ **可用** |
| SCB1 | - | ❌ 无CLK定义 | - | ❌ 不可用 |
| SCB2 | P14_x | ❌ 无SELECT0 | - | ❌ 不可用 |
| SCB3 | P13_x | ✅ P13_3 | IPS114屏幕 | ❌ 已占用 |
| SCB4 | P6_x | ✅ P6_3 | 摄像头数据 | ❌ 已占用 |
| SCB5 | P5_x/P7_x | ⚠️ 仅SELECT2 | - | ❌ 不可用 |

#### 2.2.4 确认的引脚分配（SCB0）

| 功能 | 引脚 | SCB | HSIOM | 说明 |
|------|------|-----|-------|------|
| **SPI从机通信** | | **SCB0** | | **Deep Sleep模式(30)** |
| MISO | **P0_0** | | P0_0_SCB0_SPI_MISO | 数据输出（向主机发送） |
| MOSI | **P0_1** | | P0_1_SCB0_SPI_MOSI | 数据输入（从主机接收） |
| CLK | **P0_2** | | P0_2_SCB0_SPI_CLK | 时钟输入 |
| SS | **P0_3** | | P0_3_SCB0_SPI_SELECT0 | 硬件片选输入 |
| **INT信号** | **P18_6** | GPIO | | **数据就绪信号输出** |

**结论：CYT2BL3使用SCB0的P0端口作为SPI从机，满足需求** ✅

#### 2.2.5 资源冲突问题及解决方案 ⚠️

**发现的问题**：Debug串口(UART_0)使用SCB0和P0_0/P0_1，与SPI从机冲突

**解决方案**：在main_cm4.c中添加条件编译宏：
```c
#define ENABLE_DEBUG_UART   0   // 设为0禁用debug串口，SPI从机独占SCB0
                                // 设为1启用debug串口，但SPI从机将无法工作
```

**后续优化方向**：将debug串口迁移到其他SCB/引脚后，可重新启用

---

## 三、通信数据分析

### 3.1 图像特征数据结构（实际实现）

```c
// 信标检测结果 - 实际实现 (spi_comm.h / spi_slave.h)
typedef struct {
    int16 center_x;      // 灯塔中心X坐标 (2字节)
    int16 center_y;      // 灯塔中心Y坐标 (2字节)
    uint8 found;         // 是否找到灯塔 (1字节)
    uint8 confidence;    // 置信度(0-100) (1字节)
} beacon_result_t;       // 总计: 6字节
```

### 3.2 数据帧格式（实际实现）

| 组成部分 | 大小 | 实际值 | 说明 |
|----------|------|--------|------|
| 帧头 HEAD | 2字节 | **0xAA 0x55** | 帧头标识 |
| 命令 CMD | 1字节 | 0x01/0x10 | 命令类型 |
| 长度 LEN | 2字节 | 小端序 | 数据长度 |
| 数据 DATA | 6字节 | beacon_result_t | 灯塔数据 |
| 校验 CRC | 2字节 | Modbus CRC16 | 校验值 |
| 帧尾 TAIL | 1字节 | **0xED** | 帧尾标识 |
| **总计** | **14字节** | | 单帧完整大小 |

### 3.3 命令定义（实际实现）

| 命令 | 值 | 说明 |
|------|-----|------|
| CMD_PING | 0x01 | 心跳测试 |
| CMD_GET_BEACON | **0x10** | 获取灯塔数据 |

### 3.4 带宽需求分析

```
单帧数据量: 14字节
通信频率: 100Hz
从机数量: 3个

单从机带宽需求: 14 × 100 = 1.4 KB/s
三从机总带宽需求: 1.4 × 3 = 4.2 KB/s

SPI@1MHz有效带宽: 约97 KB/s
裕量: 97 / 4.2 ≈ 23倍

结论: 带宽充足 ✅
```

### 3.5 轮询时序分析（100Hz目标）

```
目标周期: 1000ms / 100Hz = 10ms

假设:
- 单次通信数据量: 20字节（含请求和响应）
- SPI时钟: 1MHz
- 传输时间: 20 × 8 / 1MHz = 0.16ms
- CS切换和处理延时: 0.1ms

单从机通信周期: 0.16 + 0.1 = 0.26ms
3从机轮询周期: 0.26 × 3 = 0.78ms

实际可达帧率: 1000 / 0.78 ≈ 1282Hz（远超100Hz需求）

结论: 轮询模式完全满足100Hz需求 ✅
```

---

## 四、INT信号事件驱动方案

### 4.1 工作原理

**INT信号握手机制**：采用TX FIFO预加载策略，从机检测CS上升沿后清除INT信号

```
从机(2BL3)                              主机(4BB7)
    │                                       │
    │  [1] 图像处理完成                       │
    │      构建响应帧到g_tx_buffer          │
    │      预加载数据到TX FIFO              │
    │                                       │
    ├───── [2] INT引脚拉高 ─────────────────►│ 检测到INT高电平
    │                                       │ (轮询检测)
    │                                       │
    │◄──────────── [3] CS拉低 ─────────────┤ 选中从机
    │      (从机检测到SS下降沿)              │ (CS建立延时5us)
    │      清空RX FIFO                     │
    │                                       │
    │◄════════════ [4] 时钟+数据 ═══════════┤ 全双工传输
    │      TX FIFO数据自动发出             │
    │                                       │
    │════════════ [5] 响应数据 ═════════════►│ 接收数据
    │                                       │
    │◄──────────── [6] CS拉高 ─────────────┤ 释放从机
    │      (从机检测到SS上升沿)              │
    │                                       │
    │  [7] INT引脚拉低                        │ 解析数据帧
    │      重新预加载TX FIFO               │ CRC校验
    │      等待下次数据就绪                   │
    │                                       │
```

**关键设计要点（实际实现）**：
1. **TX FIFO预加载**：从机在拉高INT之前，必须先将数据预加载到TX FIFO
2. **CS建立延时**：主机拉低CS后延时5us，确保从机TX FIFO准备完成
3. **SS边沿检测**：从机轮询检测P0_3(SS)引脚状态，上升沿时清除INT并重新预加载
4. **g_data_pending标志**：跟踪数据是否待发送，避免重复通知

### 4.2 引脚分配（用户确认）

**CYT4BB7 主机端：**

| 功能 | 引脚 | 说明 |
|------|------|------|
| **SPI_0 总线** | | |
| CLK | P02_2 | 时钟输出（共享） |
| MOSI | P02_1 | 数据输出（共享） |
| MISO | P02_0 | 数据输入（共享） |
| **CS/INT (单从机测试)** | | |
| CS_1 | P02_3 | 片选1（GPIO软件控制） |
| INT_1 | P02_4 | 数据就绪检测1 |
| **CS/INT (从机2)** | | |
| CS_2 | P01_0 | 片选2（GPIO） |
| INT_2 | P01_1 | 数据就绪检测2 |
| **CS/INT (从机3)** | | |
| CS_3 | P19_0 | 片选3（GPIO） |
| INT_3 | P19_1 | 数据就绪检测3 |

**CYT2BL3 从机端（所有从机相同，使用SCB0）：**

| 功能 | 引脚 | HSIOM | 说明 |
|------|------|-------|------|
| MISO | P0_0 | 30 | 数据输出 |
| MOSI | P0_1 | 30 | 数据输入 |
| CLK | P0_2 | 30 | 时钟输入 |
| SS | P0_3 | 30 | 硬件片选输入 |
| INT_OUT | **P18_6** | GPIO | 数据就绪信号输出 |

**注意**: SCB0使用Deep Sleep HSIOM模式(值=30)，支持完整的SPI从机功能。

### 4.3 INT信号优势

1. **真正的事件驱动**：不浪费CPU时间轮询
2. **最低延迟**：数据就绪即刻通知
3. **CPU效率高**：主机可以做其他任务
4. **支持异步更新**：各从机可独立更新

---

## 五、软件可行性分析

### 5.1 SPI从机模式支持

#### 5.1.1 底层SDK支持

```c
// cy_scb_spi.h:432-433
#define CY_SCB_SPI_SLAVE  (0ul)  // SPI从机模式 ✅
#define CY_SCB_SPI_MASTER (1ul)  // SPI主机模式
```

**结论：Cypress PDL底层完整支持SPI从机模式** ✅

#### 5.1.2 逐飞库限制

**当前逐飞库只封装了SPI主机模式**，已自行实现SPI从机驱动 ✅

### 5.2 开发策略确认

| 阶段 | 策略 | 状态 |
|------|------|------|
| 第一阶段 | 基础通信验证（中断模式） | ✅ **已完成** |
| 第二阶段 | 主机DMA优化 | 🔄 **进行中** |
| 第三阶段 | 多从机扩展 | ⏳ 待开始 |

**备选方案**：FIFO批量填充（已验证，保留在 `fifo-batch-transfer` 分支）

### 5.3 测试策略确认

| 阶段 | 配置 | 状态 |
|------|------|------|
| 第一阶段 | 1个4BB7 + 1个2BL3 | ✅ **已完成** |
| 第二阶段 | 1个4BB7 + 3个2BL3 | ⏳ 待开始 |

---

## 六、技术风险评估

### 6.1 已解决的风险

| 风险项 | 原风险等级 | 解决方案 | 状态 |
|-------|----------|---------|------|
| SPI从机驱动开发 | 🔴 高 | 基于Cypress PDL直接操作SCB0寄存器 | ✅ 已解决 |
| INT信号时序协调 | 🟡 中 | TX FIFO预加载策略 + SS边沿检测 | ✅ 已解决 |
| SCB0资源冲突 | 🟡 中 | ENABLE_DEBUG_UART条件编译 | ✅ 已解决 |

### 6.2 待解决的风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|-------|---------|------|----------|
| 多从机同步 | 🟡 中 | 系统稳定性 | 分阶段扩展，充分测试 |

### 6.3 低风险项

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|-------|---------|------|----------|
| 通信带宽 | 🟢 低 | 无 | 带宽远超需求（23倍裕量@1MHz） |
| 时钟适配 | 🟢 低 | 性能 | 设计可配置时钟参数 |

---

## 七、可行性结论

### 7.1 总体评估

| 评估维度 | 结论 | 可行性 |
|---------|------|--------|
| 硬件资源 | SPI_0(4BB7) + SCB0(2BL3)完全满足 | ✅ 可行 |
| 软件支持 | 底层PDL支持完善，从机驱动已开发 | ✅ **已验证** |
| 性能指标 | 带宽23倍裕量@1MHz，100Hz轻松达成 | ✅ 可行 |
| 兼容性 | 与mknm_car_new不冲突（WiFi/TOF未使用） | ✅ 可行 |
| 技术风险 | 核心风险已解决，仅剩DMA优化 | ✅ 可控 |

### 7.2 第一阶段验证结果

**验证状态**：✅ **成功**

**测试配置**：
- 主机：CYT4BB7 (SPI_0/SCB7)
- 从机：CYT2BL3 (SCB0)
- SPI速率：1MHz
- 连接方式：排线约5cm

**验证数据**：
```
Beacon: x=160, y=120, found=1, conf=85
Beacon: x=170, y=125, found=1, conf=90
Beacon: x=180, y=130, found=1, conf=80
...
```

**数据变化规律验证**：
- center_x: 每次+10，模320循环 ✅
- center_y: 每次+5，模240循环 ✅
- confidence: 80 + (center_x % 20) ✅

### 7.3 最终结论

**方案可行** ✅ **第一阶段已验证成功**

**已实现配置**：
- **单SPI_0 + GPIO CS + INT信号**
- 事件驱动通信模式
- TX FIFO预加载策略
- 1MHz SPI时钟

**引脚分配**：
- **4BB7 SPI_0**: CLK=P02_2, MOSI=P02_1, MISO=P02_0
- **从机1 (测试)**: CS=P02_3, INT=P02_4
- **从机2**: CS=P01_0, INT=P01_1
- **从机3**: CS=P19_0, INT=P19_1
- **2BL3 SCB0**: MISO=P0_0, MOSI=P0_1, CLK=P0_2, SS=P0_3 (HSIOM=30)
- **2BL3 INT输出**: P18_6

---

## 附录

### A. 实际代码文件

| 功能 | 文件路径 |
|------|---------|
| 主机通信模块 | `4bb7/4bb7_2bl3_spi/code/spi_comm.c/h` |
| 从机通信模块 | `2bl3/4bb7_2bl3_spi/code/spi_slave.c/h` |
| 主机主程序 | `4bb7/4bb7_2bl3_spi/user/main_cm7_0.c` |
| 从机主程序 | `2bl3/4bb7_2bl3_spi/user/main_cm4.c` |

### B. 参考代码位置

| 功能 | 参考代码路径 |
|------|-------------|
| SPI主机(4BB7) | `mknm_car_new/libraries/zf_driver/zf_driver_spi.c` |
| SPI主机(2BL3) | `4bb7_2bl3_spi/2bl3/libraries/zf_driver/zf_driver_spi.c` |
| SCB SPI底层 | `libraries/sdk/common/src/drivers/scb/cy_scb_spi.c` |
| 菜单系统 | `mknm_car_new/mknm_car/code/menu/` |

### C. 官方参考资源

- [Infineon SPI Master with DMA Example](https://github.com/Infineon/mtb-t2g-lite-example-spi-master-dma)
- [AN225401 - How to use SCB in TRAVEO T2G](https://documentation.infineon.com/traveo/docs/qmr1680597505537)

### D. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12 | 初版可行性分析 |
| v2.0 | 2024-12 | 添加INT信号机制 |
| v3.0 | 2024-12 | 确认SCB0为SPI从机 |
| v3.1 | 2024-12 | INT信号时序优化 |
| v4.0 | 2025-12 | 第一阶段验证完成，更新协议和实现细节 |
| v4.1 | 2025-12 | 调整开发阶段顺序：先DMA优化，后多从机扩展 |
| v4.2 | 2025-12 | FIFO批量填充方案验证成功（保留在fifo-batch-transfer分支） |
| **v4.3** | **2025-12** | **第二阶段DMA优化开发中，FIFO批量填充作为备选方案** |
