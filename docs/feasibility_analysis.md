# 多芯片SPI通信方案可行性分析

> **文档版本**：v3.1（INT信号时序优化版）
> **日期**：2025年
> **项目**：3×CYT2BL3 + 1×CYT4BB7 SPI通信系统
> **修订说明**：v3.1 更新INT信号握手机制（从机检测CS上升沿清除INT）

---

## 一、方案概述

### 1.1 系统架构

```
                    ┌─────────────────┐
                    │   CYT4BB7       │
                    │   (SPI主机)     │
                    │                 │
                    │  SPI_0 (SCB7) ──┼─────┬─────┬───── 共享总线
                    │                 │     │     │
                    │  GPIO CS控制    │     │     │
                    │    CS_1 (P02_3)─┼─────┼─────┼──► 2BL3_1
                    │    CS_2 (P01_0)─┼─────┼─────┼──► 2BL3_2
                    │    CS_3 (P19_0)─┼─────┼─────┼──► 2BL3_3
                    │                 │     │     │
                    │  GPIO INT检测   │     │     │
                    │    INT_1 (P02_4)◄─────┼─────┼─── 2BL3_1
                    │    INT_2 (P01_1)◄─────┼─────┼─── 2BL3_2
                    │    INT_3 (P19_1)◄─────┼─────┼─── 2BL3_3
                    │                 │     │     │
                    └─────────────────┘     │     │
```

### 1.2 各芯片功能定位

| 芯片 | 角色 | 主要功能 |
|------|------|----------|
| CYT4BB7 | 主机 | SPI主机通信×3、图像特征融合、运动学解算、全向移动控制 |
| CYT2BL3_1 | 从机 | 摄像头图像采集处理、信标检测、菜单系统、SPI从机通信 |
| CYT2BL3_2 | 从机 | 摄像头图像采集处理、信标检测、菜单系统、SPI从机通信 |
| CYT2BL3_3 | 从机 | 摄像头图像采集处理、信标检测、菜单系统、SPI从机通信 |

### 1.3 已确认的需求参数

| 参数 | 确认值 | 备注 |
|------|--------|------|
| 物理连接 | 排线约5cm（测试），PCB直连（将来） | SPI时钟需可便捷切换 |
| 通信频率 | 100Hz | 需可便捷更改 |
| 实施方案 | 单硬件SPI + 3个GPIO CS | 方案D |
| INT信号 | 需要 | 事件驱动通信 |
| 菜单系统 | 3个从机独立 | 照搬mknm_car_new设计 |
| 开发策略 | 先中断模式，后DMA | 渐进式开发 |
| 测试策略 | 先1主1从，后扩展3从 | 分阶段验证 |

---

## 二、硬件资源可行性分析

### 2.1 CYT4BB7资源分析

#### 2.1.1 SCB模块资源

根据Infineon官方数据手册：

| 特性 | 规格 |
|------|------|
| SCB总数 | **11个** (SCB0-SCB10) |
| SPI最大时钟 | 12.5 MHz |
| FIFO深度 | 可配置 |
| DMA支持 | 完善的PDMA支持 |

#### 2.1.2 逐飞库SPI通道映射（4BB7）

```c
// 来源：zf_driver_spi.c:48
volatile stc_SCB_t* spi_module[4] = {SCB7, SCB8, SCB9, SCB6};

// SPI_0 -> SCB7: P02_0/P02_1/P02_2/P02_3 ✅ 本项目使用
// SPI_1 -> SCB8: P12_0/P12_1/P12_2/P12_3 (IPS114占用)
// SPI_2 -> SCB9: P15_0/P15_1/P15_2/P15_3 (IMU660RA占用)
// SPI_3 -> SCB6: P03_0/P03_1/P03_2/P03_3
```

#### 2.1.3 mknm_car_new SPI资源占用情况

| SPI通道 | SCB | 引脚端口 | **占用设备** | **状态** |
|--------|-----|---------|-------------|----------|
| **SPI_0** | **SCB7** | **P02端口** | **WiFi未启用** | ✅ **本项目使用** |
| SPI_1 | SCB8 | P12端口 | **IPS114屏幕** | ❌ 已占用 |
| SPI_2 | SCB9 | P15端口 | **IMU660RA** | ❌ 已占用 |
| SPI_3 | SCB6 | P03端口 | 未使用 | ✅ 可用(备选) |

### 2.2 CYT2BL3资源分析

#### 2.2.1 SCB模块资源

| 特性 | 规格 |
|------|------|
| SCB总数 | **8个** (SCB0-SCB7) |
| SPI支持 | 主机和从机模式 |
| SPI最大时钟 | 12.5 MHz |

#### 2.2.2 逐飞库SPI通道映射（2BL3）

```c
// 来源：zf_driver_spi.c:48
volatile stc_SCB_t* spi_module[4] = {SCB4, SCB5, SCB3, SCB2};

// SPI_1 -> SCB4: P06端口 (摄像头数据占用)
// SPI_2 -> SCB5: P07端口
// SPI_3 -> SCB3: P13端口 (IPS114屏幕占用)
// SPI_4 -> SCB2: P14端口 (无硬件SS引脚，不可用于从机模式)
```

**重要发现**: SCB2的P14端口没有SPI_SELECT0的HSIOM定义，无法作为SPI从机使用硬件SS引脚。

#### 2.2.3 SPI从机可用资源分析

经过对gpio_cyt2bl_64_lqfp.h的详细分析，只有**SCB0**具备完整的SPI从机功能：

| SCB | 引脚端口 | SELECT0支持 | 占用状态 | 可用性 |
|-----|---------|-------------|----------|--------|
| SCB0 | P0_x | ✅ P0_3 | **未占用** | ✅ **可用** |
| SCB1 | - | ❌ 无CLK定义 | - | ❌ 不可用 |
| SCB2 | P14_x | ❌ 无SELECT0 | - | ❌ 不可用 |
| SCB3 | P13_x | ✅ P13_3 | IPS114屏幕 | ❌ 已占用 |
| SCB4 | P6_x | ✅ P6_3 | 摄像头数据 | ❌ 已占用 |
| SCB5 | P5_x/P7_x | ⚠️ 仅SELECT2 | - | ❌ 不可用 |

#### 2.2.4 确认的引脚分配（SCB0）

| 功能 | 引脚 | SCB | HSIOM | 说明 |
|------|------|-----|-------|------|
| **SPI从机通信** | | **SCB0** | | **Deep Sleep模式(30)** |
| MISO | **P0_0** | | P0_0_SCB0_SPI_MISO | 数据输出（向主机发送） |
| MOSI | **P0_1** | | P0_1_SCB0_SPI_MOSI | 数据输入（从主机接收） |
| CLK | **P0_2** | | P0_2_SCB0_SPI_CLK | 时钟输入 |
| SS | **P0_3** | | P0_3_SCB0_SPI_SELECT0 | 硬件片选输入 |
| **INT信号** | **P18_6** | GPIO | | **数据就绪信号输出** |

**结论：CYT2BL3使用SCB0的P0端口作为SPI从机，满足需求** ✅

---

## 三、通信数据分析

### 3.1 图像特征数据结构（用户确认）

```c
typedef struct {
    uint8_t  beacon_found;       // 是否检测到信标 (1字节)
    uint8_t  beacon_count;       // 检测到的信标数量 (1字节)
    int16_t  nearest_beacon_x;   // 最近信标 X 坐标 (2字节)
    int16_t  nearest_beacon_y;   // 最近信标 Y 坐标 (2字节)
} beacon_result_t;               // 总计: 6字节
```

### 3.2 数据帧大小估算

| 组成部分 | 大小 | 说明 |
|----------|------|------|
| 帧头 HEAD | 2字节 | 0x5A 0xA5 |
| 命令 CMD | 1字节 | 命令类型 |
| 长度 LEN | 2字节 | 数据长度（小端） |
| 数据 DATA | 6字节 | beacon_result_t |
| 校验 CRC | 2字节 | CRC16 |
| 帧尾 TAIL | 1字节 | 0xAA |
| **总计** | **14字节** | 单帧完整大小 |

### 3.3 带宽需求分析

```
单帧数据量: 14字节
通信频率: 100Hz
从机数量: 3个

单从机带宽需求: 14 × 100 = 1.4 KB/s
三从机总带宽需求: 1.4 × 3 = 4.2 KB/s

SPI@8MHz有效带宽: 约780 KB/s
裕量: 780 / 4.2 ≈ 185倍

结论: 带宽极其充足 ✅
```

### 3.4 轮询时序分析（100Hz目标）

```
目标周期: 1000ms / 100Hz = 10ms

假设:
- 单次通信数据量: 20字节（含请求和响应）
- SPI时钟: 8MHz
- 传输时间: 20 × 8 / 8MHz = 0.02ms
- CS切换和处理延时: 0.1ms

单从机通信周期: 0.02 + 0.1 = 0.12ms
3从机轮询周期: 0.12 × 3 = 0.36ms

实际可达帧率: 1000 / 0.36 ≈ 2778Hz（远超100Hz需求）

结论: 轮询模式完全满足100Hz需求 ✅
```

---

## 四、INT信号事件驱动方案

### 4.1 工作原理

**INT信号握手机制**：从机检测到CS上升沿（主机完成读取）后清除INT信号

```
从机(2BL3)                              主机(4BB7)
    │                                       │
    │  [1] 图像处理完成                       │
    │      数据预加载到TX FIFO               │
    │                                       │
    ├───── [2] INT引脚拉高 ─────────────────►│ 检测到INT上升沿
    │                                       │ 加入待处理队列
    │                                       │
    │◄──────────── [3] CS拉低 ─────────────┤ 选中从机
    │      (从机检测到CS下降沿)               │
    │                                       │
    │◄════════════ [4] 请求数据 ════════════┤
    │                                       │
    │════════════ [5] 响应数据 ═════════════►│
    │                                       │
    │◄──────────── [6] CS拉高 ─────────────┤ 释放从机
    │      (从机检测到CS上升沿)               │
    │                                       │
    │  [7] INT引脚拉低                        │ 处理数据
    │      等待下次数据就绪                    │
    │                                       │
```

**关键设计要点**：
1. **数据先于INT**：从机必须先将数据预加载到TX FIFO，然后才拉高INT
2. **CS触发清除**：从机检测到CS上升沿后主动清除INT，避免时序竞争
3. **状态机保护**：从机使用状态机确保数据准备完成后才通知主机

### 4.2 引脚分配（用户确认）

**CYT4BB7 主机端：**

| 功能 | 引脚 | 说明 |
|------|------|------|
| **SPI_0 总线** | | |
| CLK | P02_2 | 时钟输出（共享） |
| MOSI | P02_1 | 数据输出（共享） |
| MISO | P02_0 | 数据输入（共享） |
| **CS/INT (单从机测试)** | | |
| CS_1 | P02_3 | 片选1（SPI0硬件CS0） |
| INT_1 | P02_4 | 数据就绪检测1 |
| **CS/INT (从机2)** | | |
| CS_2 | P01_0 | 片选2（GPIO） |
| INT_2 | P01_1 | 数据就绪检测2 |
| **CS/INT (从机3)** | | |
| CS_3 | P19_0 | 片选3（GPIO） |
| INT_3 | P19_1 | 数据就绪检测3 |

**CYT2BL3 从机端（所有从机相同，使用SCB0）：**

| 功能 | 引脚 | HSIOM | 说明 |
|------|------|-------|------|
| MISO | P0_0 | 30 | 数据输出 |
| MOSI | P0_1 | 30 | 数据输入 |
| CLK | P0_2 | 30 | 时钟输入 |
| SS | P0_3 | 30 | 硬件片选输入 |
| INT_OUT | **P18_6** | GPIO | 数据就绪信号输出 |

**注意**: SCB0使用Deep Sleep HSIOM模式(值=30)，支持完整的SPI从机功能。

### 4.3 INT信号优势

1. **真正的事件驱动**：不浪费CPU时间轮询
2. **最低延迟**：数据就绪即刻通知
3. **CPU效率高**：主机可以做其他任务
4. **支持异步更新**：各从机可独立更新

---

## 五、软件可行性分析

### 5.1 SPI从机模式支持

#### 5.1.1 底层SDK支持

```c
// cy_scb_spi.h:432-433
#define CY_SCB_SPI_SLAVE  (0ul)  // SPI从机模式 ✅
#define CY_SCB_SPI_MASTER (1ul)  // SPI主机模式
```

**结论：Cypress PDL底层完整支持SPI从机模式** ✅

#### 5.1.2 逐飞库限制

**当前逐飞库只封装了SPI主机模式**，需要自行实现SPI从机驱动 ⚠️

### 5.2 开发策略确认

| 阶段 | 策略 | 目标 |
|------|------|------|
| 第一阶段 | 中断模式 | 验证基础通信 |
| 第二阶段 | DMA优化 | 提升效率 |

### 5.3 测试策略确认

| 阶段 | 配置 | 目标 |
|------|------|------|
| 第一阶段 | 1个4BB7 + 1个2BL3 | 验证单从机通信 |
| 第二阶段 | 1个4BB7 + 3个2BL3 | 验证多从机轮询 |

---

## 六、技术风险评估

### 6.1 高风险项

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|-------|---------|------|----------|
| SPI从机驱动开发 | 🔴 高 | 核心功能 | 参考PDL和官方示例开发 |

### 6.2 中风险项

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|-------|---------|------|----------|
| INT信号时序协调 | 🟡 中 | 通信稳定性 | 设计合理的握手机制 |
| DMA配置复杂度 | 🟡 中 | 开发周期 | 先实现中断模式，后优化DMA |

### 6.3 低风险项

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|-------|---------|------|----------|
| 通信带宽 | 🟢 低 | 无 | 带宽远超需求（185倍裕量） |
| 时钟适配 | 🟢 低 | 性能 | 设计可配置时钟参数 |

---

## 七、可行性结论

### 7.1 总体评估

| 评估维度 | 结论 | 可行性 |
|---------|------|--------|
| 硬件资源 | SPI_0(4BB7) + SCB0(2BL3)完全满足 | ✅ 可行 |
| 软件支持 | 底层PDL支持完善，需开发从机驱动 | ✅ 可行(需开发) |
| 性能指标 | 带宽185倍裕量，100Hz轻松达成 | ✅ 可行 |
| 兼容性 | 与mknm_car_new不冲突（WiFi/TOF未使用） | ✅ 可行 |
| 技术风险 | 主要风险为SPI从机驱动开发 | ⚠️ 可控 |

### 7.2 最终结论

**方案可行** ✅

**推荐实施方案**：
- **单SPI_0 + 3个GPIO CS + 3个INT信号**
- 事件驱动通信模式
- 100Hz更新频率
- 先中断模式验证，后DMA优化

**引脚分配**：
- **4BB7 SPI_0**: CLK=P02_2, MOSI=P02_1, MISO=P02_0
- **从机1 (测试)**: CS=P02_3, INT=P02_4
- **从机2**: CS=P01_0, INT=P01_1
- **从机3**: CS=P19_0, INT=P19_1
- **2BL3 SCB0**: MISO=P0_0, MOSI=P0_1, CLK=P0_2, SS=P0_3 (HSIOM=30)
- **2BL3 INT输出**: P18_6

---

## 附录

### A. 参考代码位置

| 功能 | 参考代码路径 |
|------|-------------|
| SPI主机(4BB7) | `mknm_car_new/libraries/zf_driver/zf_driver_spi.c` |
| SPI主机(2BL3) | `4bb7_2bl3_spi/2bl3/libraries/zf_driver/zf_driver_spi.c` |
| SCB SPI底层 | `libraries/sdk/common/src/drivers/scb/cy_scb_spi.c` |
| 菜单系统 | `mknm_car_new/mknm_car/code/menu/` |

### B. 官方参考资源

- [Infineon SPI Master with DMA Example](https://github.com/Infineon/mtb-t2g-lite-example-spi-master-dma)
- [AN225401 - How to use SCB in TRAVEO T2G](https://documentation.infineon.com/traveo/docs/qmr1680597505537)
